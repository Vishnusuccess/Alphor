<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Alphor â€” Phase 1 Autonomous Actions</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<style>
@keyframes kpiPulse {
  0% { transform: scale(1); color: inherit; }
  50% { transform: scale(1.2); color: #4f46e5; }
  100% { transform: scale(1); color: inherit; }
}
.kpi-animate {
  animation: kpiPulse 0.6s ease;
}
</style>

<body class="bg-gray-100 text-gray-800">

<!-- HEADER -->
<header class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white px-6 py-5 flex justify-between items-center shadow-lg">
  <div>
    <h1 class="text-3xl font-bold">Alphor</h1>
    <p class="text-sm text-purple-200">Phase 1 â€” Autonomous Decision Engine</p>
  </div>
  <div class="flex items-center space-x-4">
    <span class="bg-green-100 text-green-800 px-4 py-1 rounded-full text-sm font-semibold">
      Autonomous Running
    </span>
    <span id="phaseStatus" class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">
      Phase 1
    </span>
  </div>
</header>

<!-- PHASE 2 TRANSITION -->
<section id="phase2Transition" class="hidden mx-6 mt-4">
  <div class="bg-green-50 border border-green-200 p-4 rounded-xl flex items-center justify-between">
    <p class="text-green-800 font-semibold">âœ… Phase 2 Ready (Autonomous Mode)</p>
    <button onclick="goToPhase2()" class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition">Go to Phase 2</button>
  </div>
</section>

<!-- KPIs -->
<section class="grid grid-cols-1 md:grid-cols-6 gap-6 p-6">
  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Total Actions</p>
    <p id="totalActions" class="text-3xl font-bold">0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Human Review Required</p>
    <p id="humanReview" class="text-3xl font-bold text-yellow-600">0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Total Discount Given</p>
    <p id="totalDiscount" class="text-3xl font-bold text-purple-600">$0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Auto Emails Sent</p>
    <p id="autoEmails" class="text-3xl font-bold text-blue-600">0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Discounts Offered</p>
    <p id="autoDiscounts" class="text-3xl font-bold text-pink-600">0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Accuracy Delta</p>
    <canvas id="accuracyDeltaChart" class="h-24"></canvas>
  </div>
</section>

<!-- CHARTS -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6 px-6 pb-6">
  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-3">Model Accuracy Over Time</h2>
    <canvas id="accuracyChart" class="h-40"></canvas>
  </div>

  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-3">Human Override Trend</h2>
    <canvas id="overrideChart" class="h-40"></canvas>
  </div>
</section>

<!-- ACTION TABLE -->
<section class="p-6">
  <div class="bg-white rounded-xl shadow">
    <div class="max-h-[420px] overflow-y-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 sticky top-0">
        <tr>
            <th class="px-3 py-1.5">Customer</th>
            <th class="px-3 py-1.5">Risk</th>
            <th class="px-3 py-1.5">Churn %</th>
            <th class="px-3 py-1.5">Decision</th>
            <th class="px-3 py-1.5">Actions</th>
            <th class="px-3 py-1.5">Discount</th>
            <th class="px-3 py-1.5">Actual Churn</th>
            <th class="px-3 py-1.5">Decision Correct</th>
            <th class="px-3 py-1.5">Action Appropriate</th>
            <th class="px-3 py-1.5">Human Override</th>
            <th class="px-3 py-1.5">Executed Action Correct</th>
            <th class="px-3 py-1.5">Details</th>
        </tr>
        </thead>

        <tbody id="actionsTable"></tbody>
      </table>
    </div>

    <div class="p-4 flex justify-end">
      <button id="submitFeedbackBtn" class="bg-purple-600 text-white px-6 py-2 rounded-xl hover:bg-purple-700">Submit Feedback</button>
      <p id="feedbackStatus" class="ml-4 text-green-700 font-semibold"></p>
    </div>
  </div>
</section>

<!-- DETAILS SIDEBAR -->
<div id="detailsSidebar" class="fixed top-0 right-0 h-full w-96 bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto">
  <div class="p-4 border-b flex justify-between items-center">
    <h2 id="detailsTitle" class="text-xl font-bold">Customer Details</h2>
    <button class="text-gray-500 hover:text-gray-700">&times;</button>
  </div>

  <div class="flex border-b">
    <button class="tabBtn px-4 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600" data-tab="overview">Overview</button>
    <button class="tabBtn px-4 py-2 font-semibold text-gray-600" data-tab="communications">Communications</button>
    <button class="tabBtn px-4 py-2 font-semibold text-gray-600" data-tab="schedule">Schedule</button>
    <button class="tabBtn px-4 py-2 font-semibold text-gray-600" data-tab="feedback">Feedback</button>
  </div>

  <div class="p-4 space-y-4">
    <div id="tab-overview" class="tabContent">
      <div id="overviewAlert"></div>
      <div id="detailsContent" class="space-y-4"></div>
    </div>

    <div id="tab-communications" class="tabContent hidden">
      <div id="commContent" class="space-y-4">
        <div>
          <p class="font-semibold">Email Draft:</p>
          <pre id="emailDraft" class="bg-gray-100 p-2 rounded overflow-x-auto whitespace-pre-wrap"></pre>
        </div>
        <div>
          <p class="font-semibold mt-4">Call Script:</p>
          <pre id="callScript" class="bg-gray-100 p-2 rounded overflow-x-auto whitespace-pre-wrap"></pre>
        </div>
      </div>
    </div>

    <div id="tab-schedule" class="tabContent hidden">
      <ul id="scheduleList" class="space-y-2 text-sm text-gray-700"></ul>
    </div>

    <div id="tab-feedback" class="tabContent hidden">
      <p id="confidence"></p>
    </div>
  </div>
</div>
<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-20 hidden z-40"></div>

<script>
const API_BASE = "http://localhost:8000";
const allPossibleActions = ["send_email", "offer_discount", "schedule_call"];
let accuracyChart, accuracyDeltaChart, overrideChart;
let actionsData = [];

/* ---------- RISK LABEL ---------- */
function riskLabel(churnProb) {
  if (churnProb < 0.40) return { label: "NO RISK", color: "bg-green-100 text-green-700" };
  if (churnProb < 0.50) return { label: "LOW", color: "bg-blue-100 text-blue-700" };
  if (churnProb < 0.70) return { label: "MODERATE", color: "bg-orange-100 text-orange-700" };
  return { label: "HIGH", color: "bg-red-100 text-red-700" };
}

/* ---------- METRICS ---------- */
async function loadMetrics() {
  try {
    const res = await fetch(`${API_BASE}/dashboard/metrics`);
    const metrics = await res.json();

    if (!metrics || metrics.length === 0) return;

    const labels = metrics.map(m => m.trained_at ? new Date(m.trained_at).toLocaleString() : "Unknown");
    const acc = metrics.map(m => typeof m.accuracy === "number" ? m.accuracy : 0);

    if (accuracyChart) accuracyChart.destroy();
    accuracyChart = new Chart(document.getElementById("accuracyChart"), {
      type: "line",
      data: { labels, datasets:[{ label:"Accuracy", data: acc, borderColor:"#4f46e5", backgroundColor:"rgba(79,70,229,.2)", fill:true, tension:0.3 }] },
      options: { scales:{ y:{ min:0, max:1, ticks:{ callback:v=>(v*100).toFixed(0)+"%" }}}}
    });

    const delta = acc.length>1 ? acc.at(-1)-acc.at(-2) : 0;
    if (accuracyDeltaChart) accuracyDeltaChart.destroy();
    accuracyDeltaChart = new Chart(document.getElementById("accuracyDeltaChart"), {
      type: "bar",
      data:{ labels:["Î” Accuracy"], datasets:[{ data:[delta], backgroundColor: delta>=0?"#16a34a":"#dc2626" }] },
      options:{ plugins:{legend:{display:false}}, scales:{y:{ ticks:{ callback:v=>(v*100).toFixed(0)+"%" }}} }
    });

    if (overrideChart) overrideChart.destroy();
    overrideChart = new Chart(document.getElementById("overrideChart"), {
      type:"line",
      data:{ labels, datasets:[{
        label:"Human Override Rate",
        data: metrics.map(m => typeof m.human_override_rate==="number"?m.human_override_rate:0),
        borderColor:"#f59e0b",
        backgroundColor:"rgba(245,158,11,.2)",
        fill:true,
        tension:0.3
      }]},
      options:{ scales:{y:{ min:0, max:1, ticks:{ callback:v=>(v*100).toFixed(0)+"%" }}} }
    });

  } catch(err) {
    console.error("Error loading metrics:", err);
  }
}

/* ---------- KPIs ---------- */
function animateKPI(element) {
  element.classList.remove("kpi-animate");
  void element.offsetWidth;
  element.classList.add("kpi-animate");
}

function updateKPIs() {
  totalActions.innerText = actionsData.length;
  animateKPI(totalActions);

  humanReview.innerText = actionsData.filter(a=>a.human_review_required).length;
  animateKPI(humanReview);

  totalDiscount.innerText = "$" + actionsData.reduce((s,a)=>s+(a.discount||0),0);
  animateKPI(totalDiscount);

  autoEmails.innerText = actionsData.filter(a=>(a.actions||[]).includes("send_email")).length;
  animateKPI(autoEmails);

  autoDiscounts.innerText = actionsData.filter(a=>(a.actions||[]).includes("offer_discount")).length;
  animateKPI(autoDiscounts);
}

/* ---------- ACTIONS ---------- */
async function loadActions() {
  try {
    const res = await fetch(`${API_BASE}/dashboard/actions`);
    const actions = await res.json();
    actionsData = actions || [];

    const tbody = document.getElementById("actionsTable");
    tbody.innerHTML = "";

    actionsData.forEach(a => {
      // âœ… show CUSTOMER ID from DB (ID), not Mongo _id
      const customerId = a.ID || a.customer_id || a.client_id || a._id;
      const customerName = a.customer_name || a.name || customerId;

      // âœ… use your DB/backend field name
      const churnProb = typeof a.churn_prob === "number" ? a.churn_prob : 0;

      const risk = riskLabel(churnProb);
      const tr = document.createElement("tr");

      function yesNoDropdown(field, value) {
        return `<select class="feedback-select border rounded px-1 py-0.5 text-sm" data-id="${customerId}" data-field="${field}">
          <option value="">Select</option>
          <option value="1" ${value===true||value===1?"selected":""}>Yes</option>
          <option value="0" ${value===false||value===0?"selected":""}>No</option>
        </select>`;
      }

      tr.innerHTML = `
        <td class="px-3 py-1.5 font-semibold">${customerName}</td>
        <td class="px-3 py-1.5"><span class="${risk.color} px-2 py-1 rounded">${risk.label}</span></td>
        <td class="px-3 py-1.5">${(churnProb*100).toFixed(1)}%</td>
        <td class="px-3 py-1.5">${a.decision || "-"}</td>
        <td class="px-3 py-1.5">${(a.actions||[]).join(", ") || "-"}</td>
        <td class="px-3 py-1.5">${a.discount ? "$"+a.discount : "-"}</td>

        <!-- âœ… Collect churn feedback (required by Phase1FeedbackItem) -->
        <td class="px-3 py-1.5">${yesNoDropdown("churn", a.churn)}</td>

        <td class="px-3 py-1.5">${yesNoDropdown("decision_correct", a.decision_correct)}</td>
        <td class="px-3 py-1.5">${yesNoDropdown("action_appropriate", a.action_appropriate)}</td>
        <td class="px-3 py-1.5">${yesNoDropdown("human_override", a.human_override)}</td>
        <td class="px-3 py-1.5">${yesNoDropdown("executed_action_correct", a.executed_action_correct)}</td>
        <td class="px-3 py-1.5"><button class="text-indigo-600 font-semibold" onclick="showDetails('${customerId}')">View</button></td>
      `;
      tbody.appendChild(tr);
    });

    updateKPIs();

  } catch(err) {
    console.error("Error loading actions:", err);
  }
}

/* ---------- FEEDBACK ---------- */
submitFeedbackBtn.onclick = async () => {
    const feedback = [];

    // --- Dropdown feedback ---
    document.querySelectorAll(".feedback-select").forEach(el => {
        if (el.value === "") return;

        let row = feedback.find(f => f.ID === el.dataset.id);
        if (!row) {
            row = { ID: el.dataset.id, churn: null, executed_action: [] };
            feedback.push(row);
        }
        row[el.dataset.field] = parseInt(el.value);
    });

    // --- Executed actions (MANDATORY for Phase 1 learning) ---
    document.querySelectorAll(".feedback-checkbox").forEach(cb => {
        let row = feedback.find(f => f.ID === cb.dataset.id);
        if (!row) {
            row = { ID: cb.dataset.id, churn: null, executed_action: [] };
            feedback.push(row);
        }

        if (cb.checked && !row.executed_action.includes(cb.value)) {
            row.executed_action.push(cb.value);
        }
    });

    // ðŸš¨ Enforce executed_action presence
    feedback.forEach(row => {
        if (!Array.isArray(row.executed_action)) {
            row.executed_action = [];
        }
    });

    if (feedback.length === 0) {
        alert("Please provide feedback before submitting.");
        return;
    }

    const res = await fetch(`${API_BASE}/feedback/phase1`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(feedback)
    });

    if (res.ok) {
        feedbackStatus.innerText = "âœ… Phase 1 feedback submitted!";
        await loadMetrics();
        await loadActions();
    } else {
        feedbackStatus.innerText = "âŒ Feedback submission failed";
    }
};


/* ---------- DETAILS SIDEBAR ---------- */
function showDetails(customerId){
  const customer = actionsData.find(c => (c.ID || c.customer_id || c.client_id || c._id) === customerId);
  if(!customer) return;

  document.getElementById("detailsTitle").innerText=`Details: ${customerId}`;
  const overviewAlert = document.getElementById("overviewAlert");
  overviewAlert.innerHTML="";

  if(customer.risk==="HIGH" || (customer.actions||[]).includes("schedule_call")){
    const alertCard = document.createElement("div");
    alertCard.className="bg-red-50 p-4 rounded-lg shadow border-l-4 border-red-600 animate-pulse";
    alertCard.innerHTML=`
      <p class="font-semibold text-red-600 mb-1">âš  Call Escalated</p>
      <p class="text-sm">Assigned to: ${customer.assigned_team||"Support Team"}</p>
      <p class="text-sm">Reason: ${customer.escalation_reason||"High Risk / Action Required"}</p>
      <p class="text-sm">Scheduled at: ${customer.scheduled_time||"Pending"}</p>
    `;
    overviewAlert.appendChild(alertCard);
  }

  const container = document.getElementById("detailsContent");
  container.innerHTML="";
  [
    {label:"Demo Brief", value:customer.demo_brief||"-"},
    {label:"Confidence", value:customer.confidence!==undefined ? (customer.confidence*100).toFixed(1)+"%" : "-"}
  ].forEach(item=>{
    const card = document.createElement("div");
    card.className="bg-gray-50 p-4 rounded-lg shadow";
    card.innerHTML=`<p class="font-semibold mb-1">${item.label}</p><pre class="text-sm whitespace-pre-wrap">${item.value}</pre>`;
    container.appendChild(card);
  });

  document.getElementById("emailDraft").innerText=customer.email_draft||"-";
  document.getElementById("callScript").innerText=customer.call_script||"-";

  const schedule=document.getElementById("scheduleList");
  schedule.innerHTML="";
  if((customer.actions||[]).includes("schedule_call")){
    const li=document.createElement("li");
    li.className="text-red-600 font-semibold";
    li.innerText=`Escalated call â†’ Assigned: ${customer.assigned_team||"Support Team"}, Scheduled: ${customer.scheduled_time||"Pending"}`;
    schedule.appendChild(li);
  }

  document.getElementById("detailsSidebar").classList.remove("translate-x-full");
  document.getElementById("sidebarOverlay").classList.remove("hidden");
}

function closeDetails(){
  document.getElementById("detailsSidebar").classList.add("translate-x-full");
  document.getElementById("sidebarOverlay").classList.add("hidden");
}

document.addEventListener("DOMContentLoaded",()=>{
  document.querySelector("#detailsSidebar button").addEventListener("click",closeDetails);
  document.getElementById("sidebarOverlay").addEventListener("click",closeDetails);
});

/* ---------- TAB SWITCHING ---------- */
document.querySelectorAll(".tabBtn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tabBtn").forEach(b=>{
      b.classList.replace("border-indigo-600","border-transparent");
      b.classList.replace("text-indigo-600","text-gray-600");
    });
    btn.classList.add("border-indigo-600","text-indigo-600");
    document.querySelectorAll(".tabContent").forEach(c=>c.classList.add("hidden"));
    document.getElementById("tab-"+btn.dataset.tab).classList.remove("hidden");
  });
});

/* ---------- PHASE 2 TRANSITION ---------- */
async function checkPhaseStatus() {
  const res = await fetch(`${API_BASE}/dashboard/system_phase`);
  const data = await res.json();

  const currentPhase = data.phase || "PHASE_1";
  document.getElementById("phaseStatus").innerText = currentPhase.replace("PHASE_","Phase ");

  // âœ… Show Phase 2 button when:
  // - already in PHASE_2, OR
  // - still in PHASE_1 but awaiting_feedback is false (meaning Phase 1 complete / ready)
  const readyForPhase2 =
    currentPhase === "PHASE_2" ||
    (currentPhase === "PHASE_1" && data.awaiting_feedback === false);

  if (readyForPhase2) {
    document.getElementById("phase2Transition").classList.remove("hidden");
  } else {
    document.getElementById("phase2Transition").classList.add("hidden");
  }
}


/* ---------- GO TO PHASE 2 DASHBOARD ---------- */
function goToPhase2(){
  fetch(`${API_BASE}/dashboard/system_phase`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ phase:"PHASE_2" })
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==="ok"){
      alert("Switched to Phase 2! You can now open the Phase 2 Dashboard.");
      window.location.href="/dashboard_static/phase2.html";
    }
  });
}

/* ---------- INIT ---------- */
window.onload = async ()=>{
  await loadMetrics();
  await loadActions();
  await checkPhaseStatus();
  setInterval(checkPhaseStatus,10000);
};
</script>
</body>
</html>
