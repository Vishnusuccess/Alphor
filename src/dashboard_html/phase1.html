<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Alphor — Phase 1 Autonomous Actions</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<style>
@keyframes kpiPulse {
  0% { transform: scale(1); color: inherit; }
  50% { transform: scale(1.2); color: #4f46e5; }
  100% { transform: scale(1); color: inherit; }
}
.kpi-animate { animation: kpiPulse 0.6s ease; }
#detailsSidebar { transition: transform 0.3s ease; }
</style>

<body class="bg-gray-100 text-gray-800">

<header class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white px-6 py-5 flex justify-between items-center shadow-lg">
  <div>
    <h1 class="text-3xl font-bold">Alphor</h1>
    <p class="text-sm text-purple-200">Phase 1 — Autonomous Decision Engine</p>
  </div>
  <div class="flex items-center space-x-4">
    <span class="bg-green-100 text-green-800 px-4 py-1 rounded-full text-sm font-semibold">Autonomous Running</span>
    <span id="phaseStatus" class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">Phase 1</span>
  </div>
</header>

<section id="phase2Transition" class="hidden mx-6 mt-4">
  <div class="bg-green-50 border border-green-200 p-4 rounded-xl flex items-center justify-between">
    <p class="text-green-800 font-semibold">✅ Phase 2 Ready (Autonomous Mode)</p>
    <button onclick="goToPhase2()" class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition">Go to Phase 2</button>
  </div>
</section>

<section class="grid grid-cols-1 md:grid-cols-6 gap-6 p-6">
  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Total Actions</p>
    <p id="totalActions" class="text-3xl font-bold">0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Human Review Required</p>
    <p id="humanReview" class="text-3xl font-bold text-yellow-600">0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Discount Budget Used</p>
    <p id="totalDiscount" class="text-3xl font-bold text-purple-600">$0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Auto Emails Sent</p>
    <p id="autoEmails" class="text-3xl font-bold text-blue-600">0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Discounts Offered</p>
    <p id="autoDiscounts" class="text-3xl font-bold text-pink-600">0</p>
  </div>

  <div class="bg-white p-4 md:p-6 rounded-xl shadow text-center">
    <p class="text-sm text-gray-500">Accuracy Delta</p>
    <canvas id="accuracyDeltaChart" class="h-24"></canvas>
  </div>
</section>

<section class="grid grid-cols-1 md:grid-cols-2 gap-6 px-6 pb-6">
  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-3">Model Accuracy Over Time</h2>
    <canvas id="accuracyChart" class="h-40"></canvas>
  </div>

  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-3">Human Override Trend</h2>
    <canvas id="overrideChart" class="h-40"></canvas>
  </div>
</section>

<section class="p-6">
  <div class="bg-white rounded-xl shadow">
    <div id="feedScroll" class="max-h-[420px] overflow-y-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 sticky top-0">
          <tr>
            <th class="px-3 py-1.5">Customer</th>
            <th class="px-3 py-1.5">Risk</th>
            <th class="px-3 py-1.5">Churn %</th>
            <th class="px-3 py-1.5">Decision</th>
            <th class="px-3 py-1.5">Actions</th>
            <th class="px-3 py-1.5">Discount</th>
            <th class="px-3 py-1.5">Actual Churn</th>
            <th class="px-3 py-1.5">Decision Correct</th>
            <th class="px-3 py-1.5">Action Appropriate</th>
            <th class="px-3 py-1.5">Human Override</th>
            <th class="px-3 py-1.5">Executed Action Correct</th>
            <th class="px-3 py-1.5">Details</th>
          </tr>
        </thead>
        <tbody id="actionsTable"></tbody>
      </table>

      <div id="loadingMoreIndicator" class="text-center text-sm text-gray-500 py-2 hidden">
        Loading more actions...
      </div>
    </div>

    <div class="p-4 flex justify-end">
      <button id="submitFeedbackBtn" class="bg-purple-600 text-white px-6 py-2 rounded-xl hover:bg-purple-700">Submit Feedback</button>
      <p id="feedbackStatus" class="ml-4 text-green-700 font-semibold"></p>
    </div>
  </div>
</section>

<!-- DETAILS SIDEBAR -->
<div id="detailsSidebar" class="fixed top-0 right-0 h-full w-96 bg-white shadow-xl transform translate-x-full z-50 overflow-y-auto">
  <div class="p-4 border-b flex justify-between items-center">
    <h2 id="detailsTitle" class="text-xl font-bold">Customer Details</h2>
    <button class="text-gray-500 hover:text-gray-700">&times;</button>
  </div>

  <div class="flex border-b">
    <button class="tabBtn px-4 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600" data-tab="overview">Overview</button>
    <button class="tabBtn px-4 py-2 font-semibold text-gray-600" data-tab="communications">Communications</button>
  </div>

  <div class="p-4 space-y-4">
    <div id="tab-overview" class="tabContent">
      <div id="detailsContent" class="space-y-4"></div>
    </div>

    <div id="tab-communications" class="tabContent hidden">
      <div>
        <p class="font-semibold">Email Draft:</p>
        <pre id="emailDraft" class="bg-gray-100 p-2 rounded overflow-x-auto whitespace-pre-wrap"></pre>
      </div>
      <div>
        <p class="font-semibold mt-4">Call Script:</p>
        <pre id="callScript" class="bg-gray-100 p-2 rounded overflow-x-auto whitespace-pre-wrap"></pre>
      </div>
    </div>
  </div>
</div>

<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-20 hidden z-40"></div>



<script>
  function moneyWhole(n) {
  const v = Math.floor(Number(n) || 0);
  return "$" + v.toLocaleString();
}

// DEMO SCALING: divide by 10 (35800 -> 3580)
function moneyDemoScaled(n, scale=10) {
  const v = Math.floor((Number(n) || 0) / scale);
  return "$" + v.toLocaleString();
}

const API_BASE = "http://localhost:8000";

let accuracyChart, accuracyDeltaChart, overrideChart;

// paging state
let skip = 0;
const PAGE_SIZE = 200;
let loadingMore = false;
let reachedEnd = false;

// store loaded rows for sidebar lookup
let actionsData = [];

/* ---------- RISK LABEL ---------- */
function riskLabel(churnProb) {
  if (churnProb < 0.40) return { label: "NO RISK", color: "bg-green-100 text-green-700" };
  if (churnProb < 0.50) return { label: "LOW", color: "bg-blue-100 text-blue-700" };
  if (churnProb < 0.70) return { label: "MODERATE", color: "bg-orange-100 text-orange-700" };
  return { label: "HIGH", color: "bg-red-100 text-red-700" };
}

/* ---------- METRICS CHARTS ---------- */
async function loadMetrics() {
  try {
    const res = await fetch(`${API_BASE}/dashboard/metrics`);
    const metrics = await res.json();
    if (!metrics || metrics.length === 0) return;

    const labels = metrics.map(m => m.trained_at ? new Date(m.trained_at).toLocaleString() : "Unknown");
    const acc = metrics.map(m => typeof m.accuracy === "number" ? m.accuracy : 0);

    if (accuracyChart) accuracyChart.destroy();
    accuracyChart = new Chart(document.getElementById("accuracyChart"), {
      type: "line",
      data: { labels, datasets:[{ label:"Accuracy", data: acc, borderColor:"#4f46e5", backgroundColor:"rgba(79,70,229,.2)", fill:true, tension:0.3 }] },
      options: { scales:{ y:{ min:0, max:1, ticks:{ callback:v=>(v*100).toFixed(0)+"%" }}}}
    });

    const delta = acc.length>1 ? acc.at(-1)-acc.at(-2) : 0;
    if (accuracyDeltaChart) accuracyDeltaChart.destroy();
    accuracyDeltaChart = new Chart(document.getElementById("accuracyDeltaChart"), {
      type: "bar",
      data:{ labels:["Δ Accuracy"], datasets:[{ data:[delta], backgroundColor: delta>=0?"#16a34a":"#dc2626" }] },
      options:{ plugins:{legend:{display:false}}, scales:{y:{ ticks:{ callback:v=>(v*100).toFixed(0)+"%" }}} }
    });

    if (overrideChart) overrideChart.destroy();
    overrideChart = new Chart(document.getElementById("overrideChart"), {
      type:"line",
      data:{ labels, datasets:[{
        label:"Human Override Rate",
        data: metrics.map(m => typeof m.human_override_rate==="number"?m.human_override_rate:0),
        borderColor:"#f59e0b",
        backgroundColor:"rgba(245,158,11,.2)",
        fill:true,
        tension:0.3
      }]},
      options:{ scales:{y:{ min:0, max:1, ticks:{ callback:v=>(v*100).toFixed(0)+"%" }}} }
    });

  } catch(err) {
    console.error("Error loading metrics:", err);
  }
}

/* ---------- KPIs FROM SUMMARY (ALL ACTIONS) ---------- */
function animateKPI(el){ el.classList.remove("kpi-animate"); void el.offsetWidth; el.classList.add("kpi-animate"); }

async function loadPhase1Summary(){
  try{
    const res = await fetch(`${API_BASE}/dashboard/phase1/summary`);
    if(!res.ok) return;
    const s = await res.json();

    totalActions.innerText = s.total ?? 0; animateKPI(totalActions);
    humanReview.innerText = s.human_review ?? 0; animateKPI(humanReview);
    totalDiscount.innerText = moneyDemoScaled(s.total_discount || 0, 10); animateKPI(totalDiscount);
    autoEmails.innerText = s.auto_emails ?? 0; animateKPI(autoEmails);
    autoDiscounts.innerText = s.discounts_offered ?? 0; animateKPI(autoDiscounts);

  } catch(e){
    console.error("summary error", e);
  }
}

/* ---------- ACTION TABLE (PAGINATED) ---------- */
function yesNoDropdown(customerId, field) {
  return `<select class="feedback-select border rounded px-1 py-0.5 text-sm" data-id="${customerId}" data-field="${field}">
    <option value="">Select</option>
    <option value="1">Yes</option>
    <option value="0">No</option>
  </select>`;
}

async function loadActions(reset=false){
  if (loadingMore) return;
  if (!reset && reachedEnd) return;
  loadingMore = true;

  const indicator = document.getElementById("loadingMoreIndicator");
  if (indicator) { indicator.innerText="Loading more actions..."; indicator.classList.remove("hidden"); }

  try{
    if(reset){
      skip = 0;
      reachedEnd = false;
      actionsData = [];
      document.getElementById("actionsTable").innerHTML = "";
    }

    const res = await fetch(`${API_BASE}/dashboard/phase1/actions?skip=${skip}&limit=${PAGE_SIZE}`);
    if(!res.ok){
      if(indicator){ indicator.innerText="⚠ Failed to load"; }
      return;
    }

    const newRows = await res.json();
    if(!Array.isArray(newRows)){
      if(indicator){ indicator.innerText="⚠ Bad server response"; }
      return;
    }

    if(newRows.length === 0){
      reachedEnd = true;
      if(indicator){ indicator.innerText="✅ All actions loaded"; }
      return;
    }

    actionsData = actionsData.concat(newRows);

    const tbody = document.getElementById("actionsTable");
    newRows.forEach(a=>{
      const customerId = a.ID || a.customer_id || a._id || "-";
      const churnProb = Number(a.churn_prob || 0);
      const risk = riskLabel(churnProb);

      const tr = document.createElement("tr");
      tr.className = "border-t hover:bg-gray-50 transition";

      tr.innerHTML = `
        <td class="px-3 py-1.5 font-semibold">${customerId}</td>
        <td class="px-3 py-1.5"><span class="${risk.color} px-2 py-1 rounded">${risk.label}</span></td>
        <td class="px-3 py-1.5">${(churnProb*100).toFixed(1)}%</td>
        <td class="px-3 py-1.5">${a.decision || "-"}</td>
        <td class="px-3 py-1.5">${(a.actions||[]).join(", ") || "-"}</td>
        <td class="px-3 py-1.5">${a.discount ? "$"+a.discount : "-"}</td>

        <td class="px-3 py-1.5">${yesNoDropdown(customerId,"churn")}</td>
        <td class="px-3 py-1.5">${yesNoDropdown(customerId,"decision_correct")}</td>
        <td class="px-3 py-1.5">${yesNoDropdown(customerId,"action_appropriate")}</td>
        <td class="px-3 py-1.5">${yesNoDropdown(customerId,"human_override")}</td>
        <td class="px-3 py-1.5">${yesNoDropdown(customerId,"executed_action_correct")}</td>

        <td class="px-3 py-1.5">
          <button class="text-indigo-600 font-semibold">View</button>
        </td>
      `;

      tr.querySelector("button").addEventListener("click",()=>showDetails(customerId));
      tbody.appendChild(tr);
    });

    skip += newRows.length;

    if(indicator) indicator.classList.add("hidden");
  } catch(e){
    console.error("loadActions error:", e);
    if(indicator){ indicator.innerText="⚠ Error loading"; }
  } finally {
    loadingMore = false;
  }
}

/* ---------- FEEDBACK (FIXED URL) ---------- */
submitFeedbackBtn.onclick = async () => {
  const feedback = [];

  document.querySelectorAll(".feedback-select").forEach(el => {
    if (el.value === "") return;

    let row = feedback.find(f => f.ID === el.dataset.id);
    if (!row) {
      row = { ID: el.dataset.id, churn: null, executed_action: [] };
      feedback.push(row);
    }
    row[el.dataset.field] = parseInt(el.value);
  });

  // IMPORTANT: your backend requires executed_action; keep empty array if none selected
  feedback.forEach(r => {
    if (!Array.isArray(r.executed_action)) r.executed_action = [];
  });

  if (feedback.length === 0) {
    alert("Please provide feedback before submitting.");
    return;
  }

  const res = await fetch(`${API_BASE}/phase_1/feedback`, {   // ✅ FIXED
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(feedback)
  });

  if (res.ok) {
    feedbackStatus.innerText = "✅ Phase 1 feedback submitted!";
    await loadMetrics();
    await loadPhase1Summary();
  } else {
    feedbackStatus.innerText = "❌ Feedback submission failed";
  }
};

/* ---------- DETAILS SIDEBAR ---------- */
function showDetails(customerId){
  const customer = actionsData.find(c => (c.ID || c.customer_id) === customerId);
  if(!customer) return;

  document.getElementById("detailsTitle").innerText = `Details: ${customerId}`;

  const container = document.getElementById("detailsContent");
  container.innerHTML = "";

  const brief = customer.brief || customer.demo_brief || "-";

  const card = document.createElement("div");
  card.className="bg-gray-50 p-4 rounded-lg shadow";
  card.innerHTML = `<p class="font-semibold mb-1">Brief</p><pre class="text-sm whitespace-pre-wrap">${brief}</pre>`;
  container.appendChild(card);

  document.getElementById("emailDraft").innerText = customer.email_draft || "-";
  document.getElementById("callScript").innerText = customer.call_script || "-";

  document.getElementById("detailsSidebar").classList.remove("translate-x-full");
  document.getElementById("sidebarOverlay").classList.remove("hidden");
}

function closeDetails(){
  document.getElementById("detailsSidebar").classList.add("translate-x-full");
  document.getElementById("sidebarOverlay").classList.add("hidden");
}
document.addEventListener("DOMContentLoaded",()=>{
  document.querySelector("#detailsSidebar button").addEventListener("click",closeDetails);
  document.getElementById("sidebarOverlay").addEventListener("click",closeDetails);
});

/* ---------- PHASE STATUS ---------- */
async function checkPhaseStatus() {
  const res = await fetch(`${API_BASE}/dashboard/system_phase`);
  const data = await res.json();

  const currentPhase = data.phase || "PHASE_1";
  document.getElementById("phaseStatus").innerText = currentPhase.replace("PHASE_","Phase ");

  const readyForPhase2 =
    currentPhase === "PHASE_2" ||
    (currentPhase === "PHASE_1" && data.awaiting_feedback === false);

  if (readyForPhase2) {
    document.getElementById("phase2Transition").classList.remove("hidden");
  } else {
    document.getElementById("phase2Transition").classList.add("hidden");
  }
}

function goToPhase2(){
  fetch(`${API_BASE}/dashboard/system_phase`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ phase:"PHASE_2" })
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==="ok"){
      window.location.href="/dashboard_static/phase2.html";
    }
  });
}

/* ---------- INIT ---------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  await loadMetrics();
  await loadPhase1Summary();
  await loadActions(true);
  await checkPhaseStatus();

  // infinite scroll
  const scroller = document.getElementById("feedScroll");
  if(scroller){
    scroller.addEventListener("scroll", async ()=>{
      const nearBottom = scroller.scrollTop + scroller.clientHeight >= scroller.scrollHeight - 80;
      if(nearBottom) await loadActions(false);
    });
  }

  // refresh summary + phase badge (fast)
  setInterval(checkPhaseStatus, 10000);
  setInterval(loadPhase1Summary, 10000);

});
</script>

</body>
</html>
