<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alphor Churn Dashboard — Phase 0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 text-gray-800">

  <!-- HEADER -->
  <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-md px-6 py-5 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold">Alphor</h1>
      <p class="text-sm text-blue-200">Customer Churn Dashboard — Phase 0</p>
    </div>
    <span class="text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-semibold">
      Learning Mode
    </span>
  </header>

  <!-- PHASE TRANSITION -->
  <section id="phaseTransition" class="hidden mx-6 mt-4">
    <div class="bg-green-50 border border-green-200 p-4 rounded-xl flex items-center justify-between">
      <p class="text-green-800 font-semibold">✅ Model is ready for Phase 1 (Autonomous Mode)</p>
      <button onclick="goToPhase1()" class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition">
        Proceed to Phase 1
      </button>
    </div>
  </section>

  <!-- OVERVIEW SUMMARY -->
  <section class="grid grid-cols-1 md:grid-cols-4 gap-6 p-6">
    <div class="bg-white p-6 rounded-xl shadow">
      <p class="text-sm text-gray-500">Customers Scored</p>
      <p id="totalCustomers" class="text-3xl font-bold mt-2">0</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow">
      <p class="text-sm text-gray-500">High Risk</p>
      <p id="highRiskCount" class="text-3xl font-bold text-red-600 mt-2">0</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow">
      <p class="text-sm text-gray-500">Medium Risk</p>
      <p id="mediumRiskCount" class="text-3xl font-bold text-yellow-600 mt-2">0</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow">
      <p class="text-sm text-gray-500">Low Risk</p>
      <p id="lowRiskCount" class="text-3xl font-bold text-green-600 mt-2">0</p>
    </div>
  </section>

  <!-- UPLOAD CSV -->
  <section class="bg-white mx-6 p-6 rounded-xl shadow-md mb-6">
    <h2 class="text-xl font-semibold mb-4">Upload Customer CSV</h2>
    <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
      <input type="file" id="csvFile" class="border rounded px-4 py-2 w-full md:w-auto" />
      <button onclick="uploadCSV()" class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 transition">
        Run Phase 0 Prediction
      </button>
    </div>
    <p id="uploadStatus" class="text-sm mt-3 text-gray-600"></p>
  </section>

  <!-- MODEL METRICS -->
  <section class="bg-white mx-6 p-6 rounded-xl shadow-md mb-6">
    <h2 class="text-xl font-semibold mb-4">Model Retraining & Metrics</h2>
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-4">
      <button onclick="retrainModel()" class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition">
        Trigger Phase 0 Retraining
      </button>
      <p id="retrainStatus" class="text-sm font-medium text-gray-700"></p>
    </div>
    <div class="flex flex-col md:flex-row gap-6">
      <div class="flex-1 bg-gray-50 rounded-xl p-4 shadow-inner">
        <canvas id="metricsChart" class="w-full h-40"></canvas>
      </div>
      <div class="flex flex-col gap-2 w-44 bg-gray-50 p-4 rounded-xl shadow-inner">
        <p class="text-sm text-gray-500">Previous Accuracy</p>
        <p id="prevAccuracy" class="text-xl font-bold">0%</p>
        <p class="text-sm text-gray-500">Updated Accuracy</p>
        <p id="updatedAccuracy" class="text-xl font-bold">0%</p>
        <p id="phase1Status" class="text-sm font-semibold text-green-700"></p>
      </div>
    </div>
  </section>

  <!-- CUSTOMER TABLE WITH FEEDBACK (scroll container) -->
  <section class="p-6">
    <div class="bg-white rounded-xl shadow">
      <div id="tableScroller" class="max-h-[520px] overflow-y-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 sticky top-0">
            <tr>
              <th class="px-4 py-2 text-left">Customer ID</th>
              <th class="px-4 py-2 text-left">Risk Level</th>
              <th class="px-4 py-2 text-left">Churn Probability</th>
              <th class="px-4 py-2 text-left">Policy Tenure</th>
              <th class="px-4 py-2 text-left">Missed Payments</th>
              <th class="px-4 py-2 text-left">Feedback</th>
            </tr>
          </thead>
          <tbody id="customerTable"></tbody>
        </table>

        <div id="loadingMoreIndicator" class="text-center text-sm text-gray-500 py-2 hidden">
          Loading more customers...
        </div>
      </div>

      <div class="p-4 flex justify-end items-center gap-4">
        <button onclick="submitAllFeedback()" class="bg-purple-600 text-white px-6 py-2 rounded-xl hover:bg-purple-700 transition">
          Submit Feedback
        </button>
        <p id="feedbackStatus" class="text-green-700 font-semibold"></p>
      </div>
    </div>
  </section>

<script>
const API_BASE = "http://localhost:8000";

let customerData = [];     // only loaded pages (for quick lookup if needed)
let metricsChart;
let prevAccuracyValue = 0;

let skip = 0;
const PAGE_SIZE = 200;
let loadingMore = false;
let reachedEnd = false;

// ---------------- UTILITY ----------------
function riskLabel(prob) {
  prob = Number(prob) || 0;
  if (prob >= 0.6) return { label: "High", color: "bg-red-100 text-red-700" };
  if (prob >= 0.3) return { label: "Medium", color: "bg-yellow-100 text-yellow-700" };
  return { label: "Low", color: "bg-green-100 text-green-700" };
}

// ---------------- PHASE 0 SUMMARY (KPIs for ALL customers) ----------------
async function loadPhase0Summary() {
  try {
    const res = await fetch(`${API_BASE}/dashboard/phase0/summary`, { cache: "no-store" });
    if (!res.ok) return;
    const s = await res.json();

    totalCustomers.innerText = s.total ?? 0;
    highRiskCount.innerText = s.high ?? 0;
    mediumRiskCount.innerText = s.medium ?? 0;
    lowRiskCount.innerText = s.low ?? 0;

    // Optional: show Phase1-ready banner based on system phase/flag
    if (s.phase_1_ready === true) {
      document.getElementById("phaseTransition").classList.remove("hidden");
    } else {
      document.getElementById("phaseTransition").classList.add("hidden");
    }
  } catch (e) {
    console.error("phase0 summary error", e);
  }
}

// ---------------- TABLE APPEND (fast) ----------------
function appendTableRows(rows) {
  const table = document.getElementById("customerTable");

  rows.forEach(c => {
    const custID = String(c.ID || "-").replace(/"/g, "").trim();
    const churnProb = Number(c.churn_prob) || 0;
    const risk = riskLabel(churnProb);

    const tenure = (c.policy_tenure != null) ? c.policy_tenure : "-";
    const missed = (c.missed_payments != null) ? c.missed_payments : "-";

    const tr = document.createElement("tr");
    tr.className = "border-t";
    tr.innerHTML = `
      <td class="px-4 py-2">${custID}</td>
      <td class="px-4 py-2">
        <span class="px-2 py-1 rounded ${risk.color} font-semibold">${risk.label}</span>
      </td>
      <td class="px-4 py-2">${(churnProb * 100).toFixed(1)}%</td>
      <td class="px-4 py-2">${tenure}</td>
      <td class="px-4 py-2">${missed}</td>
      <td class="px-4 py-2">
        <select class="feedback-select border rounded px-2 py-1 text-sm" data-id="${custID}">
          <option value="">--</option>
          <option value="1">Churned</option>
          <option value="0">Not Churned</option>
        </select>
      </td>
    `;
    table.appendChild(tr);
  });
}

// ---------------- PHASE 0 CUSTOMERS (PAGINATED) ----------------
async function loadPhase0Customers(reset=false) {
  if (loadingMore) return;
  if (!reset && reachedEnd) return;

  loadingMore = true;
  const indicator = document.getElementById("loadingMoreIndicator");

  try {
    if (reset) {
      skip = 0;
      reachedEnd = false;
      customerData = [];
      document.getElementById("customerTable").innerHTML = "";
      if (indicator) { indicator.innerText = "Loading more customers..."; indicator.classList.add("hidden"); }
    }

    if (indicator) { indicator.innerText = "Loading more customers..."; indicator.classList.remove("hidden"); }

    const res = await fetch(`${API_BASE}/dashboard/phase0/customers?skip=${skip}&limit=${PAGE_SIZE}`, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const rows = await res.json();
    if (!Array.isArray(rows) || rows.length === 0) {
      reachedEnd = true;
      if (indicator) { indicator.innerText = "✅ All customers loaded"; indicator.classList.remove("hidden"); }
      return;
    }

    customerData = customerData.concat(rows);
    appendTableRows(rows);

    skip += rows.length;

    if (indicator) indicator.classList.add("hidden");
  } catch (err) {
    console.error("Phase0 customers load failed:", err);
    if (indicator) {
      indicator.innerText = "⚠ Failed to load more";
      indicator.classList.remove("hidden");
      setTimeout(() => indicator.classList.add("hidden"), 1500);
    }
  } finally {
    loadingMore = false;
  }
}

// ---------------- FEEDBACK ----------------
async function submitAllFeedback() {
  const feedbackElements = document.querySelectorAll(".feedback-select");
  const feedbackData = [];
  feedbackElements.forEach(sel => {
    const val = sel.value;
    if (val !== "") feedbackData.push({ ID: sel.dataset.id, actual_churn: Number(val) });
  });

  if (feedbackData.length === 0) return alert("No feedback selected");

  try {
    await fetch(`${API_BASE}/dashboard/feedback`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(feedbackData)
    });
    document.getElementById("feedbackStatus").innerText = "Feedback submitted!";
    setTimeout(()=>{ document.getElementById("feedbackStatus").innerText=""; }, 3000);
  } catch (err) {
    console.error(err);
    alert("Failed to submit feedback");
  }
}

// ---------------- CSV UPLOAD ----------------
async function uploadCSV() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Please select a CSV file");

  const formData = new FormData();
  formData.append("file", file);

  document.getElementById("uploadStatus").innerText = "Processing...";

  try {
    const res = await fetch(`${API_BASE}/phase_0/predict`, { method: "POST", body: formData });
    if (!res.ok) throw new Error("Upload failed");

    const data = await res.json();
    document.getElementById("uploadStatus").innerText = data.message || "Uploaded";

    // Refresh KPIs + reload table from top
    await loadPhase0Summary();
    await loadPhase0Customers(true);
  } catch (err) {
    console.error(err);
    document.getElementById("uploadStatus").innerText = err.message;
  }
}

// ---------------- RETRAIN MODEL ----------------
async function retrainModel() {
  document.getElementById("retrainStatus").innerText = "Retraining in progress...";
  try {
    const res = await fetch(`${API_BASE}/phase_0/retrain`, {method:"POST"});
    const data = await res.json();

    if (!res.ok) throw new Error(data.detail || "Retraining failed");

    document.getElementById("retrainStatus").innerText = "Retraining done!";
    document.getElementById("prevAccuracy").innerText = (prevAccuracyValue*100).toFixed(2) + "%";
    document.getElementById("updatedAccuracy").innerText = (Number(data.accuracy || 0)*100).toFixed(2) + "%";
    prevAccuracyValue = Number(data.accuracy || 0);

    document.getElementById("phase1Status").innerText = prevAccuracyValue >= 0.7 ? "✅ Phase 1 Ready" : "";

    await loadPhase0Summary();
    await loadPhase0Customers(true);
    await loadMetrics();
  } catch (err) {
    console.error(err);
    document.getElementById("retrainStatus").innerText = "Retraining failed!";
  }
}

// ---------------- METRICS CHART ----------------
async function loadMetrics() {
  try {
    const res = await fetch(`${API_BASE}/dashboard/metrics`, { cache: "no-store" });
    const metrics = await res.json();

    const filtered = (metrics || []).filter(m => m.trained_at && m.accuracy != null);
    const labels = filtered.map(m => new Date(m.trained_at).toLocaleString());
    const accuracyData = filtered.map(m => Number(m.accuracy));

    const ctx = document.getElementById("metricsChart").getContext("2d");
    if (metricsChart) metricsChart.destroy();

    metricsChart = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'Validation Accuracy',
          data:accuracyData,
          borderColor:'rgba(37, 99, 235, 1)',
          backgroundColor:'rgba(37, 99, 235, 0.2)',
          tension:0.3,
          fill:true
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          y:{min:0,max:1,ticks:{callback:v=>(v*100).toFixed(0)+'%'}},
          x:{ticks:{maxRotation:45,minRotation:0}}
        }
      }
    });
  } catch (err) {
    console.error("Failed to load metrics", err);
  }
}

function goToPhase1() {
  window.location.href = "phase1.html";
}

// ---------------- INIT ----------------
document.addEventListener("DOMContentLoaded", async () => {
  await loadPhase0Summary();
  await loadPhase0Customers(true);
  await loadMetrics();

  // infinite scroll
  const scroller = document.getElementById("tableScroller");
  if (scroller) {
    scroller.addEventListener("scroll", async () => {
      const nearBottom = scroller.scrollTop + scroller.clientHeight >= scroller.scrollHeight - 80;
      if (nearBottom) await loadPhase0Customers(false);
    });
  }

  // Refresh summary periodically (KPIs always correct)
  setInterval(loadPhase0Summary, 10000);

  // Optional: refresh table only if user is at top (prevents wiping while scrolling)
  setInterval(async () => {
    const sc = document.getElementById("tableScroller");
    if (!sc) return;
    if (sc.scrollTop < 10) await loadPhase0Customers(true);
  }, 15000);
});
</script>

</body>
</html>
